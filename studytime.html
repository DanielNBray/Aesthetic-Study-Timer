<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Stopwatch</title>

<!-- Font: Source Sans 3 -->
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;700;800;900&display=swap" rel="stylesheet">

<style>
  :root{
    --btn:#134e13;
    --fg:#ffffff;
    --shadow:0 8px 22px rgba(0,0,0,.35);
    --gap:14px;
    --btn-h:56px;
    --z-cluster:5;
    --z-top:9;
    --z-sidebar:10;
    --z-toast:11;
  }

  /* Background */
  body{
    margin:0;
    height:100svh;
    background:url("file:///C:/Users/dannb/OneDrive/Desktop/timerthing/market.jpg") center / cover no-repeat fixed;
    font-family:"Source Sans 3", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color:var(--fg);
  }

  .scrim{ position:fixed; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.32)); }
  .shade{ position:fixed; inset:0; pointer-events:none; background:linear-gradient(270deg, rgba(0,0,0,.28), rgba(0,0,0,0) 30%); opacity:0; transition:opacity .25s ease; }
  body.info-open .shade{ opacity:1; }

  /* Center the stopwatch + controls as a single block, always */
  .wrap{ position:fixed; inset:0; display:grid; place-items:center; padding:clamp(12px,4vw,40px); }
  .stack{ display:grid; justify-items:center; align-items:center; gap:var(--gap); }
  body.info-open .stack{ filter: drop-shadow(0 10px 30px rgba(0,0,0,.35)); }

  /* GOAL (above timer) */
  .goal{
    width:var(--clock-w, 420px);
    display:grid; gap:8px;
    background:rgba(0,0,0,.22);
    border-radius:14px; padding:.6rem .8rem;
    box-shadow: var(--shadow);
    border:1px solid rgba(255,255,255,.08);
  }
  .goal-row{ display:flex; align-items:center; gap:10px; justify-content:space-between; }
  .goal-left{ display:flex; align-items:center; gap:10px; }
  .goal-label{ font-weight:800; opacity:.95; }
  .goal-text{ font-weight:800; }
  .goal-pct{ font-weight:800; opacity:.9; }
  .goal-edit{
    -webkit-tap-highlight-color:transparent; background:#0f3d0f; color:#fff; border:none; cursor:pointer;
    border-radius:10px; padding:.35rem .6rem; font-weight:800; box-shadow:var(--shadow);
  }
  .goal-bar{ width:100%; height:8px; background:rgba(255,255,255,.14); border-radius:999px; overflow:hidden; }
  .goal-fill{ height:100%; width:0%; background:#1c7a3a; border-radius:999px; transition:width .2s ease; }

  /* CLOCK: fixed width via ghost so digits never shift */
  .clock-wrap{ display:grid; place-items:center; }
  .ghost{ visibility:hidden; white-space:pre; user-select:none; pointer-events:none; }
  .time{
    grid-area:1/1;
    font-variant-numeric:tabular-nums;
    line-height:1;
    font-weight:900;
    letter-spacing:.02em;
    text-shadow:none;
    font-size:clamp(80px, 20vw, 260px);
    margin:0;
  }

  /* CONTROLS: constant height & width; only the visible buttons exist (no hidden rows) */
  .controls{
    width:var(--clock-w, 420px);
    height:var(--btn-h);
    display:grid; gap:var(--gap);
    justify-items:stretch; align-items:stretch;
    transition:grid-template-columns .25s ease, width .2s ease;
  }
  body.mode-pre .controls,
  body.mode-running .controls { grid-template-columns: 1fr; }
  body.mode-paused .controls { grid-template-columns: repeat(3, 1fr); }

  button{
    -webkit-tap-highlight-color:transparent;
    appearance:none; border:none; cursor:pointer;
    background:var(--btn); color:#fff;
    height:var(--btn-h);
    padding:0 1.5rem; border-radius:18px;
    font-size:clamp(14px, 3.2vw, 18px); font-weight:800;
    transition: transform .1s ease, filter .15s ease, opacity .2s ease;
    box-shadow:var(--shadow);
  }
  button:hover{ transform:translateY(-1px); filter:brightness(1.08); }
  button:active{ transform:translateY(0); filter:brightness(.96); }
  button:focus-visible{ outline:3px solid #0b300b; outline-offset:3px; }

  /* Show only the relevant buttons per mode */
  body.mode-pre     #resumeBtn,
  body.mode-pre     #saveBtn,
  body.mode-pre     #discardBtn,
  body.mode-running #resumeBtn,
  body.mode-running #saveBtn,
  body.mode-running #discardBtn { display:none !important; }
  body.mode-paused  #startPause { display:none !important; }

  /* Top-right: current subject pill to the LEFT of analytics button */
  .pill-top{
    position:fixed; top:16px; right:calc(16px + 52px + 10px);
    background:#0d6b2b; color:#fff; padding:.35rem .6rem; border-radius:999px; font-weight:800;
    box-shadow:var(--shadow); user-select:none; z-index:var(--z-top);
    border:1px solid rgba(255,255,255,.12);
  }

  /* Analytics button (top-right) */
  .top-right{ position:fixed; top:16px; right:16px; z-index:var(--z-top); }
  .icon-btn{ width:52px; height:52px; border-radius:14px; display:grid; place-items:center; padding:0;
    background:var(--btn); box-shadow:var(--shadow); }

  /* Bottom-right cluster: subject chooser + fullscreen */
  .br-cluster{
    position:fixed; right:16px; bottom:16px; z-index:var(--z-cluster);
    display:flex; gap:10px; align-items:end;
  }

  /* Subject dropdown menu */
  .menu{
    position:fixed; right:84px; bottom:76px;
    background:#0e1d0e; color:#fff;
    border-radius:14px;
    box-shadow:0 14px 30px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.08) inset;
    overflow:hidden; opacity:0; transform:translateY(8px) scale(.98);
    pointer-events:none; transition:opacity .2s ease, transform .2s ease; min-width:180px; z-index:var(--z-top);
  }
  .menu.show{ opacity:1; transform:translateY(0) scale(1); pointer-events:auto; }
  .menu button{ all:unset; display:block; width:100%; cursor:pointer; padding:.85rem 1rem; font-weight:800; }
  .menu button:hover{ background:#124012; }
  .menu .hdr{ padding:.75rem 1rem; background:#133513; font-weight:800; opacity:.92; }

  /* Analytics sidebar */
  .sidebar{
    position:fixed; top:0; right:0; height:100vh; width:min(500px, 92vw);
    background:#0e1d0e; color:#f6fff6;
    transform:translateX(100%); transition:transform .25s ease;
    box-shadow:-20px 0 40px rgba(0,0,0,.45);
    padding:22px 20px 28px; z-index:var(--z-sidebar); overflow:auto;
  }
  body.info-open .sidebar{ transform:none; }
  .close{ position:absolute; top:12px; right:12px; }
  .sidebar h2{ margin:0 0 4px; font-weight:800; }
  .muted{ opacity:.8; margin:0 0 14px; }
  .divider{ height:1px; background:linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); margin:12px 0; }
  .badge{ display:inline-block; padding:.2rem .5rem; border-radius:999px; background:#103410; border:1px solid rgba(255,255,255,.08); font-weight:800; }
  .stat-grid{ display:grid; grid-template-columns: 1fr auto; gap:8px 12px; align-items:center; margin:14px 0 22px; }

  /* Bar chart + tooltip */
  .chart-wrap{ margin-top:10px; position:relative; }
  .chart-legend{ display:flex; justify-content:space-between; font-weight:700; opacity:.9; font-size:.95rem; }
  .chart{ width:100%; height:180px; display:block; }
  .tooltip{
    position:absolute; top:0; left:0; transform:translate(-9999px,-9999px);
    background:#0d6b2b; color:#fff; padding:.35rem .55rem; border-radius:10px; font-weight:800; font-size:.9rem;
    white-space:nowrap; pointer-events:none; box-shadow:var(--shadow);
  }

  /* Toast */
  .toast{
    position:fixed; top:16px; left:50%; transform:translateX(-50%);
    background:#0d6b2b; color:#fff; padding:.6rem 1rem; border-radius:12px;
    font-weight:800; opacity:0; pointer-events:none; transition:opacity .25s ease, transform .25s ease;
    box-shadow:var(--shadow); z-index:var(--z-toast);
  }
  .toast.show{ opacity:1; transform:translate(-50%, 0); }
</style>
</head>
<body class="mode-pre">
  <div class="scrim"></div>
  <div class="shade" aria-hidden="true"></div>

  <!-- Current subject pill (top-right, left of analytics) -->
  <div id="subjectPillTop" class="pill-top">Maths</div>

  <!-- Analytics (top-right) -->
  <button id="infoBtn" class="icon-btn top-right" aria-label="Study analytics">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <circle cx="12" cy="12" r="10" fill="none" stroke="white" stroke-width="2"/>
      <path d="M12 10v7m0-10h.01" stroke="white" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>

  <!-- Bottom-right cluster: subject chooser + fullscreen -->
  <div class="br-cluster">
    <button id="subjectBtn" class="icon-btn" title="Choose subject" aria-haspopup="menu" aria-expanded="false" aria-controls="subjectMenu">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 6.5A2.5 2.5 0 0 1 6.5 4H20v15H7a3 3 0 0 0-3 3V6.5Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
        <path d="M7 4v15" stroke="white" stroke-width="2"/>
      </svg>
    </button>
    <button id="full" class="icon-btn" title="Fullscreen" aria-label="Toggle fullscreen">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 9V4h5M20 9V4h-5M4 15v5h5M20 15v5h-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  <!-- Subject dropdown -->
  <div id="subjectMenu" class="menu" role="menu" aria-label="Subjects">
    <div class="hdr">Select subject</div>
    <script>
      // Auto-generate subject buttons from configuration
      document.addEventListener('DOMContentLoaded', () => {
        const subjectMenu = document.getElementById('subjectMenu');
        const hdr = subjectMenu.querySelector('.hdr');
        hdr.insertAdjacentHTML('afterend', SUBJECT_CONFIG.subjectButtons);
      });
    </script>
  </div>

  <!-- Analytics sidebar -->
  <aside id="sidebar" class="sidebar" aria-label="Study analytics dashboard">
    <button id="closeInfo" class="icon-btn close" aria-label="Close analytics">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M6 6l12 12M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    <h2>Study Analytics</h2>
    <p class="muted">Current subject: <span id="curSubject" class="badge">Maths</span></p>

    <div class="divider"></div>
    <h3 style="margin:0 0 8px;font-weight:800;">Overall</h3>
    <div class="stat-grid">
      <div>Total time</div><div id="overallTime" class="badge">00:00</div>
      <div>Day streak</div><div id="streak" class="badge">0 days</div>
    </div>

    <div class="divider"></div>
    <h3 style="margin:0 0 8px;font-weight:800;">By Subject</h3>
    <div class="stat-grid">
      <script>
        // Auto-generate subject stats from configuration
        document.addEventListener('DOMContentLoaded', () => {
          const statGrid = document.querySelector('.stat-grid');
          statGrid.innerHTML = SUBJECT_CONFIG.subjectStats;
        });
      </script>
    </div>

    <div class="divider"></div>
    <h3 style="margin:0 0 8px;font-weight:800;">Last 7 Days</h3>
    <div class="chart-wrap" id="chartWrap">
      <svg id="barChart" class="chart" viewBox="0 0 700 180" preserveAspectRatio="xMidYMax meet" aria-label="Last 7 days study chart"></svg>
      <div id="chartLegend" class="chart-legend"></div>
      <div id="chartTooltip" class="tooltip">00:00</div>
    </div>
  </aside>

  <div id="toast" class="toast">Saved!</div>

  <main class="wrap">
    <section class="stack" role="group" aria-label="Stopwatch">
      <!-- Goal -->
      <div class="goal">
        <div class="goal-row">
          <div class="goal-left">
            <span class="goal-label">Study goal</span>
            <button id="editGoal" class="goal-edit" title="Set goal time">Edit</button>
          </div>
          <div>
            <span id="goalText" class="goal-text">25:00</span>
            &nbsp;&middot;&nbsp;
            <span id="goalPct" class="goal-pct">0%</span>
          </div>
        </div>
        <div class="goal-bar"><div id="goalFill" class="goal-fill"></div></div>
        <!-- Goal jingle -->
        <audio id="goalSound" preload="auto"
          src="file:///C:/Users/dannb/OneDrive/Desktop/timerthing/JR%20Station%20Notification.mp3"></audio>
      </div>

      <!-- Clock -->
      <div id="clockWrap" class="clock-wrap">
        <div class="ghost" aria-hidden="true">88:88:88</div>
        <div id="display" class="time" aria-live="polite" aria-atomic="true">00:00</div>
      </div>

      <!-- Controls -->
      <div id="controls" class="controls">
        <button id="startPause">Start</button>
        <button id="resumeBtn"  aria-label="Resume">Resume</button>
        <button id="saveBtn"    aria-label="Save">Save</button>
        <button id="discardBtn" aria-label="Discard">Discard</button>
      </div>
    </section>
  </main>

<script>
(() => {
  /* ----------------------- State ----------------------- */
  // ==================== CONFIGURATION ====================
  // Easy subject configuration - modify these arrays to change subjects
  const SUBJECTS = ['Maths', 'Coding', 'Econometrics', 'Finance'];
  const DEFAULT_SUBJECT = 'Maths'; // Must be one of the subjects above

  // Auto-generated variables - DO NOT MODIFY BELOW THIS LINE
  const SUBJECT_CONFIG = {
    names: SUBJECTS,
    default: DEFAULT_SUBJECT,
    // Generate HTML elements and IDs automatically
    get subjectButtons() {
      return this.names.map(subject => 
        `<button data-subject="${subject}" role="menuitem">${subject}</button>`
      ).join('');
    },
    get subjectStats() {
      return this.names.map(subject => 
        `<div>${subject}</div><div id="s${subject}" class="badge">00:00</div>`
      ).join('');
    },
    get subjectsObject() {
      return this.names.reduce((obj, subject) => {
        obj[subject] = 0;
        return obj;
      }, {});
    },
    get subjectsObjectWithDefaults() {
      return this.names.reduce((obj, subject) => {
        obj[subject] = Number(raw.subjects?.[subject]) || 0;
        return obj;
      }, {});
    }
  };
  // ==================== END CONFIGURATION ====================

  let startTs = 0;     // performance.now() at (re)start
  let elapsed = 0;     // ms accumulated while paused
  let rafId = null;
  let goalSeconds = Number(localStorage.getItem('goalSeconds') || 1500); // default 25 min
  let goalHitThisSession = false;
  let selectedSubject = localStorage.getItem('selectedSubject') || SUBJECT_CONFIG.default;

  const display     = document.getElementById('display');
  const clockWrap   = document.getElementById('clockWrap');
  const controls    = document.getElementById('controls');

  const startPause  = document.getElementById('startPause');
  const resumeBtn   = document.getElementById('resumeBtn');
  const saveBtn     = document.getElementById('saveBtn');
  const discardBtn  = document.getElementById('discardBtn');

  const infoBtn     = document.getElementById('infoBtn');
  const closeInfo   = document.getElementById('closeInfo');

  const subjectBtn  = document.getElementById('subjectBtn');
  const subjectMenu = document.getElementById('subjectMenu');
  const subjectPillTop = document.getElementById('subjectPillTop');
  const curSubjectEl= document.getElementById('curSubject');

  const toast       = document.getElementById('toast');
  const chartWrap   = document.getElementById('chartWrap');
  const barChart    = document.getElementById('barChart');
  const chartLegend = document.getElementById('chartLegend');
  const tooltip     = document.getElementById('chartTooltip');

  const editGoalBtn = document.getElementById('editGoal');
  const goalText    = document.getElementById('goalText');
  const goalPct     = document.getElementById('goalPct');
  const goalFill    = document.getElementById('goalFill');
  const goalSound   = document.getElementById('goalSound');


  /* ----------------------- Layout lock ----------------------- */
  function setControlsWidth(){
    const w = Math.ceil(clockWrap.getBoundingClientRect().width);
    document.documentElement.style.setProperty('--clock-w', w + 'px');
  }
  new ResizeObserver(setControlsWidth).observe(clockWrap);
  window.addEventListener('resize', setControlsWidth);
  window.addEventListener('load', setControlsWidth);

  /* ----------------------- Time formatting ----------------------- */
  function fmtSec(total){
    const h = Math.floor(total/3600);
    const m = Math.floor((total%3600)/60);
    const s = total%60;
    const pad = n => String(n).padStart(2,'0');
    return total>=3600 ? `${h}:${pad(m)}:${pad(s)}` : `${pad(m)}:${pad(s)}`;
  }
  function fmt(ms){ return fmtSec(Math.floor(ms/1000)); }

  function tick(){
    const now = performance.now();
    const ms = (now - startTs) + elapsed;
    display.textContent = fmt(ms);

    // Goal progress & jingle
    const pct = Math.min(100, Math.round((ms/1000) / goalSeconds * 100));
    goalPct.textContent = pct + '%';
    goalFill.style.width = pct + '%';
    if (!goalHitThisSession && (ms/1000) >= goalSeconds){
      goalHitThisSession = true;
      try { goalSound.currentTime = 0; goalSound.play(); } catch {}
    }
    rafId = requestAnimationFrame(tick);
  }

  /* ----------------------- Modes ----------------------- */
  function setMode(mode){
    document.body.classList.remove('mode-pre','mode-running','mode-paused');
    document.body.classList.add(mode);
    if(mode === 'mode-pre'){ startPause.textContent = 'Start'; }
    else if(mode === 'mode-running'){ startPause.textContent = 'Pause'; }
  }

  function start(){ startTs = performance.now(); rafId = requestAnimationFrame(tick); setMode('mode-running'); }
  function pause(){ cancelAnimationFrame(rafId); rafId=null; elapsed += performance.now() - startTs; setMode('mode-paused'); }
  function resume(){ startTs = performance.now(); rafId = requestAnimationFrame(tick); setMode('mode-running'); }
  function reset(){ cancelAnimationFrame(rafId); rafId=null; startTs=0; elapsed=0; display.textContent='00:00'; goalHitThisSession=false; setMode('mode-pre'); }

  /* ----------------------- Buttons ----------------------- */
  startPause.addEventListener('click', () => { if(rafId) pause(); else start(); });
  resumeBtn.addEventListener('click', resume);
  discardBtn.addEventListener('click', reset);

  // Save session → add to totals + daily + subject, then reset
  saveBtn.addEventListener('click', () => {
    const seconds = Math.floor(elapsed/1000);
    if(seconds>0){
      const totals = loadTotals();
      totals.overall += seconds;
      totals.subjects[selectedSubject] += seconds;
      const d = todayKey(new Date());
      totals.daily[d] = (totals.daily[d] || 0) + seconds;
      saveTotals(totals);
      refreshAnalytics();
      toast.textContent = `Saved to ${selectedSubject}!`;
      toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 1400);
    }
    reset();
  });

  /* ----------------------- Keyboard ----------------------- */
  window.addEventListener('keydown', (e) => {
    if (e.key === ' ') { e.preventDefault(); startPause.click(); }
    if (e.key.toLowerCase() === 'r') discardBtn.click();
    if (e.key === 'Escape' && document.body.classList.contains('info-open')) {
      document.body.classList.remove('info-open');
    }
  });

  /* ----------------------- Fullscreen ----------------------- */
  document.getElementById('full').addEventListener('click', () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
    else document.exitFullscreen();
  });

  /* ----------------------- Subject selection ----------------------- */
  function setSubject(sub){
    selectedSubject=sub;
    localStorage.setItem('selectedSubject', sub);
    subjectPillTop.textContent=sub;
    document.getElementById('curSubject').textContent=sub;
  }
  setSubject(selectedSubject);

  subjectBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const open = subjectMenu.classList.toggle('show');
    subjectBtn.setAttribute('aria-expanded', String(open));
  });
  subjectMenu.querySelectorAll('button[data-subject]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      setSubject(e.currentTarget.dataset.subject);
      subjectMenu.classList.remove('show');
      subjectBtn.setAttribute('aria-expanded','false');
    });
  });
  document.addEventListener('click', (e)=>{
    if(subjectMenu.classList.contains('show') &&
       !subjectMenu.contains(e.target) &&
       e.target!==subjectBtn){
      subjectMenu.classList.remove('show');
      subjectBtn.setAttribute('aria-expanded','false');
    }
  });

  /* ----------------------- Analytics sidebar ----------------------- */
  infoBtn.addEventListener('click', () => { refreshAnalytics(); document.body.classList.add('info-open'); });
  closeInfo.addEventListener('click', () => document.body.classList.remove('info-open'));

  function loadTotals(){
    try{
      const raw = JSON.parse(localStorage.getItem('studyTotals')||'{}');
      return {
        overall: Number(raw.overall)||0,
        subjects: SUBJECT_CONFIG.subjectsObjectWithDefaults,
        daily: raw.daily || {}   // { 'YYYY-MM-DD': seconds }
      };
    }catch{
      return { overall:0, subjects:SUBJECT_CONFIG.subjectsObject, daily:{} };
    }
  }
  function saveTotals(t){ localStorage.setItem('studyTotals', JSON.stringify(t)); }

  function todayKey(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const da=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }
  function dayLabel(d){ return d.toLocaleDateString(undefined,{weekday:'short'}); }

  function calcStreak(daily){
    // consecutive days ending today; today must have >0 to count
    let streak=0;
    const now = new Date();
    for(let i=0;i<3650;i++){
      const dt = new Date(now); dt.setDate(now.getDate()-i);
      const key = todayKey(dt);
      const sec = Number(daily[key]||0);
      if(i===0 && sec===0){ return 0; }
      if(sec>0){ streak++; } else { break; }
    }
    return streak;
  }

  /* ---------- Minimal Y-axis + hover/tooltip bar chart ---------- */
  function render7DayChart(daily){
    const days=[], values=[];
    const today = new Date();
    for(let i=6;i>=0;i--){
      const dt = new Date(today); dt.setDate(today.getDate()-i);
      const key = todayKey(dt);
      days.push(dayLabel(dt));
      values.push(Number(daily[key]||0));
    }

    const W=700, H=180, padL=48, padR=24, topPad=24, baseY=H-28, barGap=12;
    const innerW = W - padL - padR;
    const barW = Math.floor((innerW - barGap*6) / 7);
    const maxVal = Math.max(1, ...values);
    const scaleH = (H - topPad - (H-baseY)); // drawable height
    const scale = (v)=> Math.round((v/maxVal) * scaleH);

    // clear
    while(barChart.firstChild) barChart.removeChild(barChart.firstChild);

    // <defs> for hover glow
    const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
    const filt = document.createElementNS('http://www.w3.org/2000/svg','filter');
    filt.setAttribute('id','glow');
    const fe = document.createElementNS('http://www.w3.org/2000/svg','feDropShadow');
    fe.setAttribute('dx','0'); fe.setAttribute('dy','2'); fe.setAttribute('stdDeviation','3');
    fe.setAttribute('flood-color','#2ad06a'); fe.setAttribute('flood-opacity','0.6');
    filt.appendChild(fe); defs.appendChild(filt); barChart.appendChild(defs);

    // minimal Y-axis (line + 0/mid/max ticks)
    const axisY = document.createElementNS('http://www.w3.org/2000/svg','line');
    axisY.setAttribute('x1', String(padL));
    axisY.setAttribute('y1', String(topPad));
    axisY.setAttribute('x2', String(padL));
    axisY.setAttribute('y2', String(baseY));
    axisY.setAttribute('stroke','rgba(255,255,255,0.25)');
    axisY.setAttribute('stroke-width','1');
    barChart.appendChild(axisY);

    const tickVals = [0, 0.5, 1];
    tickVals.forEach(t=>{
      const y = baseY - Math.round(scaleH * t);
      const tick = document.createElementNS('http://www.w3.org/2000/svg','line');
      tick.setAttribute('x1', String(padL-6));
      tick.setAttribute('x2', String(padL));
      tick.setAttribute('y1', String(y));
      tick.setAttribute('y2', String(y));
      tick.setAttribute('stroke','rgba(255,255,255,0.35)');
      tick.setAttribute('stroke-width','1');
      barChart.appendChild(tick);

      const lblSec = Math.round(maxVal * t);
      const lblTxt = document.createElementNS('http://www.w3.org/2000/svg','text');
      lblTxt.setAttribute('x', String(padL-8));
      lblTxt.setAttribute('y', String(y+4));
      lblTxt.setAttribute('text-anchor','end');
      lblTxt.setAttribute('font-size','12');
      lblTxt.setAttribute('font-weight','700');
      lblTxt.setAttribute('fill','rgba(234,255,244,0.85)');
      lblTxt.textContent = lblSec>=60 ? `${Math.round(lblSec/60)}m` : `${lblSec}s`;
      barChart.appendChild(lblTxt);
    });

    // X-axis baseline
    const axisX = document.createElementNS('http://www.w3.org/2000/svg','line');
    axisX.setAttribute('x1', String(padL));
    axisX.setAttribute('y1', String(baseY));
    axisX.setAttribute('x2', String(W-padR));
    axisX.setAttribute('y2', String(baseY));
    axisX.setAttribute('stroke','rgba(255,255,255,0.25)');
    axisX.setAttribute('stroke-width','1');
    barChart.appendChild(axisX);

    // bars + labels with hover interactions
    values.forEach((v, i)=>{
      const x = padL + i*(barW+barGap);
      const h = scale(v);
      const y = baseY - h;

      const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x', String(x));
      rect.setAttribute('y', String(y));
      rect.setAttribute('width', String(barW));
      rect.setAttribute('height', String(h));
      rect.setAttribute('rx','8');
      rect.setAttribute('fill','#1c7a3a');
      rect.dataset.seconds = String(v);
      rect.dataset.day = days[i];
      barChart.appendChild(rect);

      const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
      txt.setAttribute('x', String(x + barW/2));
      txt.setAttribute('y', String(H-8));
      txt.setAttribute('text-anchor','middle');
      txt.setAttribute('font-size','14');
      txt.setAttribute('font-weight','700');
      txt.setAttribute('fill','#eafff4');
      txt.textContent = days[i];
      barChart.appendChild(txt);

      // Hover interactions
      rect.addEventListener('mouseenter', (e)=>{
        rect.setAttribute('fill','#239c4a');
        rect.setAttribute('filter','url(#glow)');
        showTooltip(e, v, days[i]);
      });
      rect.addEventListener('mouseleave', ()=>{
        rect.setAttribute('fill','#1c7a3a');
        rect.removeAttribute('filter');
        hideTooltip();
      });
      rect.addEventListener('mousemove', (e)=> showTooltip(e, v, days[i]));
    });

    // legend
    const maxMin = Math.round(maxVal/60);
    chartLegend.textContent = maxVal>0 ? `Peak day ~ ${maxMin} min` : 'No data yet';
  }

  function showTooltip(evt, seconds, day){
    tooltip.textContent = `${day} — ${fmtSec(seconds)}`;
    const wrapRect = chartWrap.getBoundingClientRect();
    const tt = tooltip;
    tt.style.transform = 'none';
    tt.style.visibility = 'hidden';
    tt.style.display = 'block';

    // position near cursor, clamped inside chartWrap
    const mouseX = evt.clientX - wrapRect.left + 12;
    const mouseY = evt.clientY - wrapRect.top  - 10;
    const tw = tt.offsetWidth, th = tt.offsetHeight;

    let x = mouseX, y = mouseY;
    if (x + tw > wrapRect.width - 8) x = wrapRect.width - tw - 8;
    if (y + th > wrapRect.height - 8) y = wrapRect.height - th - 8;
    if (y < 0) y = 0;

    tt.style.left = x + 'px';
    tt.style.top  = y + 'px';
    tt.style.visibility = 'visible';
  }
  function hideTooltip(){
    tooltip.style.display = 'none';
    tooltip.style.visibility = 'hidden';
  }

  function refreshAnalytics(){
    const t = loadTotals();
    document.getElementById('overallTime').textContent = fmtSec(t.overall);
    SUBJECT_CONFIG.names.forEach(subject => {
      const element = document.getElementById(`s${subject}`);
      if (element) element.textContent = fmtSec(t.subjects[subject]);
    });

    const streak = calcStreak(t.daily);
    document.getElementById('streak').textContent = `${streak} ${streak===1?'day':'days'}`;

    render7DayChart(t.daily);
  }

  /* ----------------------- Goal UI ----------------------- */
  function updateGoalUI(){ goalText.textContent = fmtSec(goalSeconds); }
  editGoalBtn.addEventListener('click', () => {
    const curMin = Math.max(1, Math.round(goalSeconds/60));
    const ans = prompt("Set study goal (minutes):", String(curMin));
    if(ans===null) return;
    const n = Math.max(1, Math.min(24*60, parseInt(ans,10) || curMin));
    goalSeconds = n*60;
    localStorage.setItem('goalSeconds', String(goalSeconds));
    goalHitThisSession = false;
    updateGoalUI();
  });

  /* ----------------------- Init ----------------------- */
  function setMode(mode){ // redefined to keep code order tidy
    document.body.classList.remove('mode-pre','mode-running','mode-paused');
    document.body.classList.add(mode);
    if(mode === 'mode-pre'){ startPause.textContent = 'Start'; }
    else if(mode === 'mode-running'){ startPause.textContent = 'Pause'; }
  }
  function init(){
    setControlsWidth();
    updateGoalUI();
    setMode('mode-pre');
    display.textContent='00:00';
  }
  init();
})();
</script>
</body>
</html>
